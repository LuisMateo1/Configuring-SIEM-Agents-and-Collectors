# Configuring SIEM Agents and Collectors
<h3>Objective</h3>

- Analyze data as part of security monitoring activities

A security information and event management (SIEM) system assists security monitoring and incident response by aggregating and correlating log and network traffic data within a single management and reporting interface. 
In this lab, I'll be configuring the SIEM and the security appliances that will send logs to the SIEM.
#
<h3>Configuring a Sensor Interface</h3>

The SIEM1 VM running Security Onion has two interfaces. eth0 is configured with the IP address 10.1.0.246 and is used as a management interface. eth1 has no IP address and is used only to sniff traffic from the local network.
All the VMs are connected to the vLOCAL switch implemented in Hyper-V. To enable eth1 to sniff traffic, it is configured as a port mirroring destination interface.
- The goal is to configure the source interfaces and test that the sensor can sniff traffic.

![image](https://github.com/user-attachments/assets/c17804c4-61b0-42f5-8a25-95215ecc5577)

The first thing to do is to run a script on the host virtual machine to enable port mirroring.
![image](https://github.com/user-attachments/assets/ab454e40-0e99-43bd-b60a-725a569c8482)

Now I'll log into the VM running the SIEM to sniff the traffic off the eth1 interface to test if port mirroring is working.
![image](https://github.com/user-attachments/assets/189a866b-d314-4758-81ea-6fa78a72bdad)
- This traffic is monitored by Bro, now called Zeek, a passive network sniffer. Zeek's ruleset will only send events considered 'interesting' to the SIEM.

Here I can see the status of the security tools being used.
![image](https://github.com/user-attachments/assets/ed26a77b-19d2-4592-8687-a3f333d8939b)
- Security Onion is the SIEM, and the Host Intrusion Prevention System (HIDS) is the SIEM client.
- siem-eth1 is this VM interface that is sniffing traffic from the network.
- Bro (Zeek) is the passive sniffer, that is monitoring the eth1 interface
- The Elastic Stack is how events get written to the SIEM, it powers the SIEM logging engine.


On the Kibana dashboard, select 'connections', under 'Bro Hunting', and scroll down to verify that hosts from the 10.1.0.0/24 network are present.
- Kibana is the visualization tool in ElasticStack and is used to configure dashboards for different categories, showing data in graph and table formats.

![image](https://github.com/user-attachments/assets/2e700e37-fa8e-4ac4-a6fc-b487db76dbce)
![image](https://github.com/user-attachments/assets/6321c933-eb53-4e3c-8c2d-68a87ed51da4)

I'll use Zenmap on another VM to run an intensive scan against 10.1.0.1. Then go back to Kibana to check if any alerts were generated. I did the scan twice and it was successful both times.
![image](https://github.com/user-attachments/assets/49ae49f7-210f-4982-98b5-e829609f2d09)

Under Alert Data > Bro Notices, here I see that the scan was detected by Bro (Zeek).
![image](https://github.com/user-attachments/assets/8861ff77-8a94-4088-b677-990ebde006b4)

Under Alert Data > NIDS, these alerts are generated by the Snort Intrusion Detection System (IDS), and its ruleset.
![image](https://github.com/user-attachments/assets/d31a6674-45a8-4376-98ec-6675d88a11cd)
#
<h3>Installing Beats Agent</h3>

Apart from capturing network traffic from the hosts, it's important to collect log information from them. To forward logs to the SIEM, I'll need to install client software. In this case, the Beats software for Windows log collection, on the Server instances.
- Beats works alongside the rest of Elastic Stack to forward events to the SIEM. ElasticSearch provides the storage and query functionality. Logstash is an engine for collecting different types of data from various sources via a pipeline. The pipeline takes inputs from syslog or a Beats agent and filters the data to normalize it.

Now on the server VM, I need to make some changes to the winlogbeat.yml file.
- In logstash output section, I changed the hosts from 'localhost:5044' to '10.1.0.246:5044' 

![image](https://github.com/user-attachments/assets/bf563c93-c63d-41ec-9009-b6cacf1fc223)
![image](https://github.com/user-attachments/assets/17f44c4f-d7db-479c-a686-770e44e6d774)

Now I'll copy the winlogbeat folder to C:\Program Files (x86)

![image](https://github.com/user-attachments/assets/edc3e8d6-93b9-4391-8812-183a04fb3671)

Using PowerShell, I'll test the file configuration
- At the bottom of the output it says 'Config OK', which means the configuration is good.
![image](https://github.com/user-attachments/assets/f5d398f0-0b6e-4a12-9a04-f898d40ca9b7)

Now I'll install the agent and run the service. On the SIEM VM, I can confirm that the firewall is allowing Beats traffic over port 5044

![image](https://github.com/user-attachments/assets/35506037-e668-4750-a0be-00724d3c4397)
![image](https://github.com/user-attachments/assets/80387be4-f4f9-42d5-a460-b8bfaf4db31d)

**Beats Dashboard**
Also on Kibana under Host Hunting, is the Beats dashboard, containing any information gathered by Beats.
![image](https://github.com/user-attachments/assets/6a78b1a1-e82d-4e82-ae33-e3300dd7a395)
![image](https://github.com/user-attachments/assets/8718dfab-6d2d-4c77-a80c-7537ef405b92)
![image](https://github.com/user-attachments/assets/e66223bf-6bfc-4d56-80a8-871e1a01750f)
#
<h3>Configuring Application Logging</h3>
The default Beats configuration for a Windows Server captures application, system, and security logs. While that's a lot of information it may not be relevant to incident detection or threat hunting. So it's important to configure application logs to send data to the SIEM.

Now I will be configuring Internet Information Services (IIS) Manager, to send access logs to Event Viewer and install the Beats agent to forward it to the SIEM.

- In Server Manager, go to Tools > IIS

![image](https://github.com/user-attachments/assets/05bca487-0f3b-4a5b-8778-74a68ee4649d)

- Choose MS1 in the connections pane, and the Logging option in the middle pane
![image](https://github.com/user-attachments/assets/1d34a388-78f6-4beb-a738-4864bb9c0827)

- Change the Log Event Destination option to 'Both log file and ETW event', and click Apply in the top right Actions pane.
![image](https://github.com/user-attachments/assets/93e2eb6a-8b08-4759-931b-49bb5532348c)

There are other important settings here, like file format, encoding, and how often logs rollover.
![image](https://github.com/user-attachments/assets/be7eafe0-0595-4ba4-ba02-ab6971261572)
![image](https://github.com/user-attachments/assets/28c1df35-ff48-4934-8155-0a59896593cd)

Now I'll install the Beats agent, which is the same process as before, except for the commands done in Powershell




